name: Build, Push and Deploy (self-hosted)

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image names
        id: set-image
        run: |
          echo "image=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/social-media-dashboard:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_frontend=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/social-media-dashboard-frontend:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GHCR (optional)
        if: ${{ env.GHCR_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Build and push backend and frontend images
        run: |
          IMAGE=${{ steps.set-image.outputs.image }}
          IMAGE_FRONTEND=${{ steps.set-image.outputs.image_frontend }}
          # Build backend
          docker build -t $IMAGE Code/social-media-dashboard/backend
          docker push $IMAGE
          # Build frontend
          docker build -t $IMAGE_FRONTEND Code/social-media-dashboard/frontend
          docker push $IMAGE_FRONTEND

      - name: Push frontend to GHCR (optional)
        if: ${{ env.GHCR_TOKEN != '' }}
        run: |
          IMAGE_FRONTEND_DOCKER=${{ steps.set-image.outputs.image_frontend }}
          IMAGE_FRONTEND_GHCR=ghcr.io/${{ github.repository_owner }}/social-media-dashboard-frontend:${{ github.sha }}
          echo "Tagging frontend for GHCR: ${IMAGE_FRONTEND_DOCKER} -> ${IMAGE_FRONTEND_GHCR}"
          docker tag ${IMAGE_FRONTEND_DOCKER} ${IMAGE_FRONTEND_GHCR}
          docker push ${IMAGE_FRONTEND_GHCR}

      - name: Publish image output
        id: publish
        run: |
          # Default to Docker Hub images
          IMAGE=${{ steps.set-image.outputs.image }}
          IMAGE_FRONTEND=${{ steps.set-image.outputs.image_frontend }}
          # If GHCR_TOKEN is available we prefer the GHCR frontend image
          if [ -n "${GHCR_TOKEN}" ]; then
            IMAGE_FRONTEND=ghcr.io/${{ github.repository_owner }}/social-media-dashboard-frontend:${{ github.sha }}
          fi
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "image_frontend=${IMAGE_FRONTEND}" >> $GITHUB_OUTPUT
          echo "::set-output name=image::${IMAGE}"
          echo "::set-output name=image_frontend::${IMAGE_FRONTEND}"
          echo "Built and published images: ${IMAGE} ${IMAGE_FRONTEND}"

      - name: Save image tags to files
        run: |
          # Use the published outputs (may point to GHCR if GHCR_TOKEN was set)
          IMAGE=${{ steps.publish.outputs.image }}
          IMAGE_FRONTEND=${{ steps.publish.outputs.image_frontend }}
          echo "${IMAGE}" > image-backend.txt
          echo "${IMAGE_FRONTEND}" > image-frontend.txt

      - name: Upload image tag artifacts
        uses: actions/upload-artifact@v4
        with:
          name: image-tag-backend
          path: image-backend.txt
      - uses: actions/upload-artifact@v4
        with:
          name: image-tag-frontend
          path: image-frontend.txt

  deploy:
    name: Deploy on self-hosted runner
    needs: build
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.3'

      - name: Show kubectl client version
        run: |
          kubectl version --client --short || true

      - name: Download image tag artifacts
        uses: actions/download-artifact@v4
        with:
          name: image-tag-backend
          path: .
      - name: Download frontend image tag artifact
        uses: actions/download-artifact@v4
        with:
          name: image-tag-frontend
          path: .

      - name: Replace IMAGE_PLACEHOLDER and apply manifests
        run: |
          # Read the image tags produced by the build job
          IMAGE=$(cat image-backend.txt)
          IMAGE_FRONTEND=$(cat image-frontend.txt)
          echo "Backend image to deploy: '${IMAGE}'"
          echo "Frontend image to deploy: '${IMAGE_FRONTEND}'"
          if [ -z "${IMAGE}" ] || [ -z "${IMAGE_FRONTEND}" ]; then
            echo "ERROR: one of the image variables is empty â€” aborting to avoid applying manifests with empty image." >&2
            exit 1
          fi
          # Replace the frontend-specific placeholder first to avoid substring
          # replacement when the generic IMAGE_PLACEHOLDER is present inside
          # IMAGE_PLACEHOLDER_FRONTEND.
          sed -i "s#IMAGE_PLACEHOLDER_FRONTEND#${IMAGE_FRONTEND}#g" Code/social-media-dashboard/k8s/*.yaml || true
          sed -i "s#IMAGE_PLACEHOLDER#${IMAGE}#g" Code/social-media-dashboard/k8s/*.yaml || true
          echo "---- Manifests after replacement (preview) ----"
          sed -n '1,160p' Code/social-media-dashboard/k8s/frontend-deployment.yaml || true
          sed -n '1,160p' Code/social-media-dashboard/k8s/backend-deployment.yaml || true
          kubectl apply -f Code/social-media-dashboard/k8s/
          # Ensure deployments explicitly use desired images as fallback
          kubectl set image deployment/backend backend=${IMAGE} || true
          kubectl set image deployment/frontend frontend=${IMAGE_FRONTEND} || true
          kubectl rollout status deployment/backend -n default --timeout=120s || true
          kubectl rollout status deployment/frontend -n default --timeout=120s || true

      - name: Wait for rollout
        run: |
          # Wait for the 'backend' deployment created in Code/social-media-dashboard/k8s/backend-deployment.yaml
          kubectl rollout status deployment/backend -n default --timeout=120s || true

      - name: Notes
        run: |
          echo "If your image is private, ensure the k3s cluster has image pull credentials (imagePullSecrets) or the runner host is logged in to Docker Hub."
