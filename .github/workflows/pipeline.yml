name: CI Pipeline

on:
  push:
    branches:
      - main
    tags:
      - '**'
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write
  packages: write
  security-events: write
  id-token: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/social-media-dashboard
  # Use tag name when the workflow is triggered by a git tag, otherwise fall back to the commit sha
  IMAGE_TAG: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}

jobs:
  debug-token:
    name: Debug GITHUB_TOKEN access
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      - name: Show run and token info
        run: |
          echo "Run id: ${{ github.run_id }}"
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
      - name: Create evidence directory structure
        run: |
          mkdir -p evidence/run
          mkdir -p evidence/sast
          mkdir -p evidence/sbom
          mkdir -p evidence/sca
          mkdir -p evidence/secrets
          mkdir -p evidence/signing
          echo "Evidence directories created for run ${{ github.run_id }}"
      - name: Save run metadata
        run: |
          echo "Run ID: ${{ github.run_id }}" > evidence/run/run-metadata.txt
          echo "Run Number: ${{ github.run_number }}" >> evidence/run/run-metadata.txt
          echo "Event: ${{ github.event_name }}" >> evidence/run/run-metadata.txt
          echo "Repository: ${{ github.repository }}" >> evidence/run/run-metadata.txt
          echo "Branch/Tag: ${{ github.ref }}" >> evidence/run/run-metadata.txt
          echo "Commit SHA: ${{ github.sha }}" >> evidence/run/run-metadata.txt
          echo "Actor: ${{ github.actor }}" >> evidence/run/run-metadata.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/run/run-metadata.txt
      - name: Upload run logs
        uses: actions/upload-artifact@v4
        with:
          name: evidence-run
          path: evidence/run/
      - name: Test Actions REST API with GITHUB_TOKEN
        env:
          GHTOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Calling: $API_URL"
          http_status=$(curl -s -o response.json -w "%{http_code}" -H "Authorization: Bearer $GHTOKEN" -H "Accept: application/vnd.github+json" "$API_URL") || true
          echo "HTTP status: $http_status"
          echo "Response body:" 
          cat response.json || true

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create evidence directories
        run: mkdir -p evidence/sbom
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft packages dir:. -o cyclonedx-json > evidence/sbom/sbom-${{ github.run_id }}.cyclonedx.json
          cp evidence/sbom/sbom-${{ github.run_id }}.cyclonedx.json sbom.cyclonedx.json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.cyclonedx.json
      - name: Upload SBOM to evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-sbom
          path: evidence/sbom/

  codeql:
    name: CodeQL SAST
    runs-on: ubuntu-latest
    needs: sbom
    steps:
      - uses: actions/checkout@v4
      - name: Create evidence directories
        run: mkdir -p evidence/sast
      # CodeQL Action v4: update before v3 deprecation (Dec 2026)
      # Note: Ensure 'Code scanning' is enabled in repository settings
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v4
        with:
          upload: true
          output: evidence/sast
      - name: Save SAST metadata
        run: |
          echo "SAST Tool: CodeQL" > evidence/sast/sast-metadata-${{ github.run_id }}.txt
          echo "Run ID: ${{ github.run_id }}" >> evidence/sast/sast-metadata-${{ github.run_id }}.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/sast/sast-metadata-${{ github.run_id }}.txt
          echo "Language: JavaScript" >> evidence/sast/sast-metadata-${{ github.run_id }}.txt
      - name: Upload SAST evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-sast
          path: evidence/sast/

  secret-scan:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest
    needs: codeql
    steps:
      - uses: actions/checkout@v4
      - name: Create evidence directories
        run: mkdir -p evidence/secrets
      - name: Run gitleaks (install + detect)
        run: |
          # Install dependencies and gitleaks (use sudo to ensure /usr/local/bin is writable)
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates
          # Remove any existing gitleaks to avoid shadowing older binaries
          sudo rm -f /usr/local/bin/gitleaks /usr/bin/gitleaks || true
          # Prefer the upstream install script; fallback to direct asset download if it fails
          set -e
          echo "Attempting to install gitleaks via install.sh"
          if curl -sSfL https://raw.githubusercontent.com/zricethezav/gitleaks/master/install.sh | sudo bash -s -- -b /usr/local/bin; then
            echo "gitleaks installed via install.sh"
          else
            echo "install.sh failed, attempting direct asset download"
            ARCH=$(uname -m)
            case "$ARCH" in
              x86_64|amd64) ASSET="gitleaks-linux-amd64" ;;
              aarch64|arm64) ASSET="gitleaks-linux-arm64" ;;
              *) ASSET="gitleaks-linux-amd64" ;;
            esac
            GITLEAKS_URL="https://github.com/zricethezav/gitleaks/releases/latest/download/${ASSET}"
            echo "Downloading $GITLEAKS_URL"
            curl -sSL --retry 3 --retry-delay 2 -f "$GITLEAKS_URL" -o /tmp/gitleaks
            sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
            sudo chmod +x /usr/local/bin/gitleaks
          fi
          # Verify installation - try multiple locations
          echo "Looking for gitleaks..."
          which gitleaks || echo "gitleaks not in PATH"
          ls -la /usr/local/bin/gitleaks 2>/dev/null || echo "Not in /usr/local/bin"
          ls -la /usr/bin/gitleaks 2>/dev/null || echo "Not in /usr/bin"
          
          # Try to find and use gitleaks with full path
          if [ -x "/usr/local/bin/gitleaks" ]; then
            GITLEAKS_BIN="/usr/local/bin/gitleaks"
          elif [ -x "/usr/bin/gitleaks" ]; then
            GITLEAKS_BIN="/usr/bin/gitleaks"
          elif command -v gitleaks >/dev/null 2>&1; then
            GITLEAKS_BIN="gitleaks"
          else
            echo "ERROR: gitleaks not found after installation!"
            echo "Creating empty report..."
            echo "[]" > gitleaks-report.json
            echo "[]" > evidence/secrets/gitleaks-report-${{ github.run_id }}.json
            exit 0
          fi
          
          # Print version for debugging
          echo "Using gitleaks at: $GITLEAKS_BIN"
          $GITLEAKS_BIN version || true
          
          # Run detect but don't let a non-zero exit (findings) stop the job
          $GITLEAKS_BIN detect --source . --report-format json --report-path gitleaks-report.json || true
          
          # Copy to evidence directory with run ID
          if [ -f gitleaks-report.json ]; then
            cp gitleaks-report.json evidence/secrets/gitleaks-report-${{ github.run_id }}.json
          else
            echo "No report file generated, creating empty report"
            echo "[]" > gitleaks-report.json
            echo "[]" > evidence/secrets/gitleaks-report-${{ github.run_id }}.json
          fi
      - name: Upload gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
      - name: Upload secrets evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-secrets
          path: evidence/secrets/
      - name: Fail if secrets found
        run: |
          if [ -s gitleaks-report.json ] && grep -q '[\[{]' gitleaks-report.json; then
            echo "Secrets detected by gitleaks, failing pipeline."
            jq length gitleaks-report.json | grep -q '^0$' || (cat gitleaks-report.json && exit 1)
          fi

  sca-scan:
    name: SCA Scan (Trivy)
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4
      - name: Create evidence directories
        run: mkdir -p evidence/sca
      - name: Install trivy
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
      - name: Run Trivy filesystem scan
        run: |
          trivy fs --format json --output evidence/sca/trivy-fs-${{ github.run_id }}.json .
          cp evidence/sca/trivy-fs-${{ github.run_id }}.json trivy-fs.json
      - name: Generate SCA summary
        run: |
          echo "SCA Tool: Trivy" > evidence/sca/sca-metadata-${{ github.run_id }}.txt
          echo "Run ID: ${{ github.run_id }}" >> evidence/sca/sca-metadata-${{ github.run_id }}.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/sca/sca-metadata-${{ github.run_id }}.txt
          trivy --version >> evidence/sca/sca-metadata-${{ github.run_id }}.txt || true
      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-fs.json
      - name: Upload SCA evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-sca
          path: evidence/sca/

  build-and-push:
    name: Build and push image
    runs-on: ubuntu-latest
    needs: sca-scan
    environment: production
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Check GHCR_TOKEN availability
        run: |
          if [ -z "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "GHCR_TOKEN is not set in repository secrets. Create a Personal Access Token (fine-grained recommended) with Packages: Read & write and add it as GHCR_TOKEN."
            exit 1
          fi
          echo "GHCR_TOKEN length: $(echo -n "${{ secrets.GHCR_TOKEN }}" | wc -c) characters"
      - name: Log in to GHCR
        # Note: Use a fine-grained Personal Access Token (PAT) named `GHCR_TOKEN` with:
        # - Repository access: Only select repositories -> choose this repo
        # - Packages: Read & write
        # If the repo is private also grant `Contents: Read`/`repo` as needed for classic tokens.
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: Build and push image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: ./Code/social-media-dashboard/backend
          file: ./Code/social-media-dashboard/backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          # build-push-action provides step output 'digest' when pushing

      - name: Build and push frontend image
        id: build-frontend
        uses: docker/build-push-action@v4
        with:
          context: ./Code/social-media-dashboard/frontend
          file: ./Code/social-media-dashboard/frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/social-media-dashboard-frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ github.repository_owner }}/social-media-dashboard-frontend:latest

      - name: Save image tags to files
        run: |
          # Backend image (GHCR) and frontend image (GHCR)
          echo "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" > image-backend.txt
          echo "ghcr.io/${{ github.repository_owner }}/social-media-dashboard-frontend:${{ env.IMAGE_TAG }}" > image-frontend.txt
      - name: Upload image tag artifacts
        uses: actions/upload-artifact@v4
        with:
          name: image-tag-backend
          path: image-backend.txt
      - uses: actions/upload-artifact@v4
        with:
          name: image-tag-frontend
          path: image-frontend.txt

  sign-image:
    name: Sign image with cosign
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Create evidence directories
        run: mkdir -p evidence/signing
      - name: Prepare debug info (non-sensitive)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_ACTOR=$GITHUB_ACTOR"
          echo "IMAGE=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
      - name: Install cosign via action
        if: github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@v3
      - name: Log in to GHCR for signing (use GHCR_TOKEN or fallback to GITHUB_TOKEN)
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN || github.token }}
      - name: Sign image (keyless) using cosign CLI
        if: github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
          COSIGN_YES: "true"
        run: |
          cosign version || true
          # keyless is the default when no --key is provided; do not pass --keyless flag
          # Prefer signing by digest to avoid tag-mutation issues. If build produced a digest, use it.
          if [ -n "${{ needs.build-and-push.outputs.image_digest }}" ]; then
            IMAGE_REF="${{ env.IMAGE_NAME }}@${{ needs.build-and-push.outputs.image_digest }}"
          else
            IMAGE_REF="${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          fi
          echo "Signing image: $IMAGE_REF"
          cosign sign "$IMAGE_REF" 2>&1 | tee evidence/signing/signing-log-${{ github.run_id }}.txt
      - name: Save signing metadata
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Image signed successfully" > evidence/signing/signing-metadata-${{ github.run_id }}.txt
          echo "Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> evidence/signing/signing-metadata-${{ github.run_id }}.txt
          echo "Digest: ${{ needs.build-and-push.outputs.image_digest }}" >> evidence/signing/signing-metadata-${{ github.run_id }}.txt
          echo "Run ID: ${{ github.run_id }}" >> evidence/signing/signing-metadata-${{ github.run_id }}.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/signing/signing-metadata-${{ github.run_id }}.txt
          echo "Actor: ${{ github.actor }}" >> evidence/signing/signing-metadata-${{ github.run_id }}.txt
          cosign version >> evidence/signing/signing-metadata-${{ github.run_id }}.txt || true
      - name: Upload signing evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-signing
          path: evidence/signing/

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [sign-image, sca-scan, secret-scan, build-and-push]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python (ensure python3 available)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trivy-report
          path: reports
      - name: Check Trivy for CVSS >= 7.0 or HIGH/CRITICAL
        run: |
          python3 .github/scripts/quality_gate.py reports/trivy-fs.json
      - name: Log in to GHCR (if image is private)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN || github.token }}

      - name: Install cosign CLI
        uses: sigstore/cosign-installer@v3

      - name: Create evidence directories
        run: mkdir -p evidence/signing
      - name: Verify cosign signature (keyless/actor-restricted)
        run: |
          # Verify keyless signatures but restrict accepted certificate identities
          # to the GitHub actor that ran the workflow to avoid accepting unrelated certs.
          cosign version || true
          cosign verify --verbose --certificate-identity-regexp ".*${{ github.actor }}.*" \
            --certificate-oidc-issuer-regexp "https://token.actions.githubusercontent.com" \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} 2>&1 | tee evidence/signing/verify-log-${{ github.run_id }}.txt || (echo "Signature missing/invalid" && exit 1)
      - name: Save verification metadata
        run: |
          echo "Image signature verified successfully" > evidence/signing/verify-metadata-${{ github.run_id }}.txt
          echo "Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> evidence/signing/verify-metadata-${{ github.run_id }}.txt
          echo "Run ID: ${{ github.run_id }}" >> evidence/signing/verify-metadata-${{ github.run_id }}.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/signing/verify-metadata-${{ github.run_id }}.txt
          echo "Actor: ${{ github.actor }}" >> evidence/signing/verify-metadata-${{ github.run_id }}.txt
      - name: Upload verification evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-signing-verify
          path: evidence/signing/

  commit-evidence:
    name: Commit Evidence to Repository
    runs-on: ubuntu-latest
    needs: [quality-gate, sbom, codeql, secret-scan, sca-scan, sign-image]
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create evidence directories in repo
        run: |
          mkdir -p evidence/run
          mkdir -p evidence/sast
          mkdir -p evidence/sbom
          mkdir -p evidence/sca
          mkdir -p evidence/secrets
          mkdir -p evidence/signing
      
      - name: Download all evidence artifacts
        uses: actions/download-artifact@v4
        with:
          path: evidence-artifacts
      
      - name: Organize evidence files
        run: |
          # Copy run metadata
          if [ -d "evidence-artifacts/evidence-run" ]; then
            cp -r evidence-artifacts/evidence-run/* evidence/run/ 2>/dev/null || true
          fi
          
          # Copy SBOM
          if [ -d "evidence-artifacts/evidence-sbom" ]; then
            cp -r evidence-artifacts/evidence-sbom/* evidence/sbom/ 2>/dev/null || true
          fi
          
          # Copy SAST
          if [ -d "evidence-artifacts/evidence-sast" ]; then
            cp -r evidence-artifacts/evidence-sast/* evidence/sast/ 2>/dev/null || true
          fi
          
          # Copy secrets
          if [ -d "evidence-artifacts/evidence-secrets" ]; then
            cp -r evidence-artifacts/evidence-secrets/* evidence/secrets/ 2>/dev/null || true
          fi
          
          # Copy SCA
          if [ -d "evidence-artifacts/evidence-sca" ]; then
            cp -r evidence-artifacts/evidence-sca/* evidence/sca/ 2>/dev/null || true
          fi
          
          # Copy signing (from both sign and verify jobs)
          if [ -d "evidence-artifacts/evidence-signing" ]; then
            cp -r evidence-artifacts/evidence-signing/* evidence/signing/ 2>/dev/null || true
          fi
          if [ -d "evidence-artifacts/evidence-signing-verify" ]; then
            cp -r evidence-artifacts/evidence-signing-verify/* evidence/signing/ 2>/dev/null || true
          fi
          
          # Create summary file
          echo "Pipeline Run Evidence Summary" > evidence/run-${{ github.run_id }}-summary.txt
          echo "================================" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Run ID: ${{ github.run_id }}" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Run Number: ${{ github.run_number }}" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Commit SHA: ${{ github.sha }}" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Branch/Tag: ${{ github.ref }}" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Actor: ${{ github.actor }}" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "" >> evidence/run-${{ github.run_id }}-summary.txt
          echo "Files Generated:" >> evidence/run-${{ github.run_id }}-summary.txt
          find evidence -type f -name "*${{ github.run_id }}*" >> evidence/run-${{ github.run_id }}-summary.txt
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push evidence
        run: |
          git add evidence/
          if git diff --staged --quiet; then
            echo "No evidence changes to commit"
          else
            git commit -m "Add evidence from pipeline run ${{ github.run_id }}

            Run Number: ${{ github.run_number }}
            Event: ${{ github.event_name }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
            
            Evidence includes:
            - SBOM (Syft)
            - SAST (CodeQL)
            - Secret Scan (gitleaks)
            - SCA (Trivy)
            - Image Signing (Cosign)
            - Run Metadata"
            
            # Push to the current branch
            git push origin HEAD:${{ github.ref_name }}
          fi

  # Note: Deployments are no longer performed in this pipeline. The pipeline
  # now only builds and pushes images to GHCR. Deployment should be done via
  # the repository Makefile (see `Code/social-media-dashboard/Makefile`) or
  # via a self-hosted workflow that explicitly performs the deploy step.